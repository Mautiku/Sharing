<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Chat - ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å (Admin Enabled)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Firebase & Crypto Imports -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "crypto-js": "https://esm.sh/crypto-js@4.2.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animation */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-anim { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from 'firebase/auth';
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc, doc, updateDoc, deleteField, arrayUnion, arrayRemove } from 'firebase/firestore';
        import { Send, Image as ImageIcon, X, Lock, Settings, Key, Eye, Trash2, Copy, User, CheckCircle, RotateCcw, CornerUpLeft, ShieldCheck, Crown } from 'lucide-react';
        import CryptoJS from 'crypto-js';

        // ==========================================
        //  Firebase Configuration (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDQdsojcaTs1jrXdzrfl2P9r3fhKox1uC8",
            authDomain: "sharing-d783e.firebaseapp.com",
            projectId: "sharing-d783e",
            storageBucket: "sharing-d783e.firebasestorage.app",
            messagingSenderId: "231742713780",
            appId: "1:231742713780:web:40b4493a63aebbd061cce1",
            measurementId: "G-T91M0M6SJZ"
        };
        // ==========================================

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // Image Compression Function
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 600;
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE/w; w = MAX_SIZE; } }
                        else { if (h > MAX_SIZE) { w *= MAX_SIZE/h; h = MAX_SIZE; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, w,); // Fix: use w, h for drawImage instead of w, w
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };
        
        // Decryption function
        const decryptData = (encryptedText, key) => {
            if (!encryptedText || !key) return null;
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedText, key);
                const decryptedJson = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedJson) return null; 
                const parsed = JSON.parse(decryptedJson);
                if (typeof parsed.text !== 'string' && typeof parsed.image !== 'string' && parsed.image !== null) {
                    return null;
                }
                return parsed; 
            } catch (e) {
                console.error("Decryption failed:", e);
                return null;
            }
        };

        // Decrypt without key (for Admin bypass)
        const decryptDataNoKey = (encryptedText) => {
            if (!encryptedText) return null;
            return {
                text: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ (‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡πÇ‡∏î‡∏¢ Admin)",
                image: null,
                encryptedContent: encryptedText
            };
        }

        const formatTime = (timestamp) => {
            if (!timestamp) return '...';
            try {
                const date = timestamp.toDate();
                return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            }
        };

        // =================================================================
        // MessageItem Component
        // =================================================================
        const MessageItem = ({ msg, isMe, isAdmin, user, onDelete, onPermanentUnlock, onReply, onUpdateReaction }) => {
            const [decryptedContent, setDecryptedContent] = useState(null);
            const [isAttemptingDecrypt, setIsAttemptingDecrypt] = useState(false);
            const [isConfirmingUnlock, setIsConfirmingUnlock] = useState(false); 
            const [decryptKey, setDecryptKey] = useState('');
            const [error, setError] = useState('');
            
            const [swipeOffset, setSwipeOffset] = useState(0);
            const touchStartRef = useRef(0);
            const SWIPE_THRESHOLD = 50;
            
            const [showReactionPicker, setShowReactionPicker] = useState(false);
            const longPressTimerRef = useRef(null);
            const EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•']; 

            const handleDecrypt = () => {
                setError('');
                if (!decryptKey.trim()) {
                    setError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™');
                    return;
                }
                
                const data = decryptData(msg.encryptedContent, decryptKey);
                
                if (data) {
                    setDecryptedContent(data);
                    setIsAttemptingDecrypt(false);
                    setError(''); 
                } else {
                    setError('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            };
            
            const handleAdminDecrypt = () => {
                const data = decryptData(msg.encryptedContent, 'admin_master_key_for_dev_test'); 
                if (data) {
                    setDecryptedContent(data);
                } else {
                    setDecryptedContent(decryptDataNoKey(msg.encryptedContent));
                }
            };
            
            const handleRelock = () => {
                setDecryptedContent(null);
                setIsAttemptingDecrypt(false);
                setIsConfirmingUnlock(false);
                setDecryptKey('');
                setError('');
            };
            
            const handleUnlockConfirmed = async () => {
                if (!decryptedContent || !msg.encryptedContent || !decryptKey) {
                    // Use custom modal or message box instead of window.alert
                    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ñ‡∏≤‡∏ß‡∏£: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    setIsConfirmingUnlock(false);
                    return;
                }
                await onPermanentUnlock(msg.id, msg.encryptedContent, decryptKey);
                handleRelock(); 
            }

            const handleTouchStart = (e) => {
                touchStartRef.current = e.touches[0].clientX;
                setSwipeOffset(0); 

                longPressTimerRef.current = setTimeout(() => {
                    setShowReactionPicker(true);
                    setSwipeOffset(0);
                }, 500);
            };

            const handleTouchMove = (e) => {
                const currentX = e.touches[0].clientX;
                const diff = currentX - touchStartRef.current;
                
                if (Math.abs(diff) > 10) { 
                    clearTimeout(longPressTimerRef.current);
                }

                if (diff > 0) {
                    setSwipeOffset(Math.min(SWIPE_THRESHOLD * 1.5, diff));
                } else {
                    setSwipeOffset(0);
                }
            };

            const handleTouchEnd = () => {
                clearTimeout(longPressTimerRef.current);
                
                if (!showReactionPicker && swipeOffset >= SWIPE_THRESHOLD) {
                    onReply(msg, contentToDisplay);
                }
                setSwipeOffset(0);
            };
            
            const handleContextMenu = (e) => {
                e.preventDefault();
                setShowReactionPicker(true);
            };

            const handleReact = (emoji) => {
                onUpdateReaction(msg.id, emoji);
                setShowReactionPicker(false);
            };
            

            let contentToDisplay = decryptedContent || { 
                text: msg.text, 
                image: msg.image 
            };
            
            const isLocked = msg.isLocked;
            const isDecrypted = isLocked && decryptedContent;
            const displayPlaceholder = isLocked && !decryptedContent;
            const showPermanentUnlock = isMe && isDecrypted;
            
            const replyQuoteClasses = isMe ? 'self-end bg-blue-700/50' : 'self-start bg-slate-700/50';

            const isSenderAdmin = msg.uid === 'mRhV0VcapENUjSUZs0wR9ce99Qg2';
            
            const senderNameClasses = isSenderAdmin 
                ? 'text-yellow-400 font-extrabold flex items-center gap-1'
                : (isMe ? 'text-blue-300 font-medium' : 'text-slate-400 font-medium');

            return (
                <div 
                    key={msg.id} 
                    className={`flex flex-col ${isMe ? 'items-end' : 'items-start'} msg-anim relative`}
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                    onContextMenu={handleContextMenu}
                >
                    {/* Reaction Picker Modal (Conditionally rendered) */}
                    {showReactionPicker && (
                        <>
                            {/* Overlay to close picker when clicking outside */}
                            <div className="fixed inset-0 z-10" onClick={() => setShowReactionPicker(false)}></div>
                            <div 
                                className="absolute z-20 p-2 rounded-full bg-slate-700/95 backdrop-blur-sm shadow-xl flex gap-1 transform -translate-y-full mb-2"
                                style={{ [isMe ? 'right' : 'left']: '10px', bottom: '0' }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                {EMOJIS.map(emoji => (
                                    <button 
                                        key={emoji}
                                        onClick={() => handleReact(emoji)}
                                        className="text-xl p-1.5 rounded-full hover:bg-slate-600 transition duration-150 transform hover:scale-110"
                                        title={`Reaction: ${emoji}`}
                                    >
                                        {emoji}
                                    </button>
                                ))}
                            </div>
                        </>
                    )}

                    {/* Hidden Reply Icon for visual feedback during swipe */}
                    <div className={`absolute left-0 top-1/2 -translate-y-1/2 transition-opacity ${swipeOffset > 10 ? 'opacity-100' : 'opacity-0'}`}>
                        <CornerUpLeft size={24} className="text-blue-400"/>
                    </div>

                    {/* Reply Quote Block (if this message is a reply) */}
                    {msg.replyToId && (
                        <div className={`text-xs text-slate-400 mb-1 px-3 py-1 rounded-t-lg max-w-[85%] ${replyQuoteClasses} border-l-2 border-blue-400`}>
                            <span className="font-semibold text-blue-300">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö {msg.replyToSender}</span>
                            <p className="text-slate-300 truncate max-w-full">{msg.replyToText}</p>
                        </div>
                    )}
                    
                    {/* Header: Time, Sender, Lock/Delete/Reply Icons */}
                    <div className={`flex items-center gap-2 mb-1 ${isMe ? 'flex-row-reverse' : ''}`}>
                        
                        {/* 1. Reply Button (alternative to swipe) */}
                        <button 
                            onClick={() => onReply(msg, contentToDisplay)} 
                            className="text-slate-400 hover:text-blue-400 p-1 rounded-full transition"
                            title="‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö"
                        >
                            <CornerUpLeft size={14} />
                        </button>
                        
                        {/* 2. Delete Button (If it's my message OR I'm an admin) */}
                        {(isMe || isAdmin) && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); onDelete(msg.id); }} 
                                className="text-red-500 hover:text-red-400 p-1 rounded-full transition"
                                title={isMe ? "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ" : "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ (Admin)"}
                            >
                                <Trash2 size={14} />
                            </button>
                        )}
                        
                        {/* 3. Permanent Unlock Button (If it's my decrypted message) */}
                        {showPermanentUnlock && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); setIsConfirmingUnlock(true); }}
                                className="text-green-500 hover:text-green-400 p-1 rounded-full transition"
                                title="‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ñ‡∏≤‡∏ß‡∏£ (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ)"
                            >
                                <CheckCircle size={14} />
                            </button>
                        )}

                        {/* 4. Local Relock Icon (If decrypted locally) */}
                        {isDecrypted && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); handleRelock(); }} 
                                className="text-blue-400 hover:text-blue-300 p-1 rounded-full transition"
                                title="‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)"
                            >
                                <RotateCcw size={14} />
                            </button>
                        )}
                        
                        {/* 5. Lock Status Icon (If locked and not decrypted) */}
                        {isLocked && !isDecrypted && (
                            <Lock size={12} className="text-red-400" title="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ" />
                        )}
                        
                        {/* 6. Sender Name and Time */}
                        <span className={`text-[10px] text-slate-500`}>{formatTime(msg.createdAt)}</span>
                        
                        <span className={`text-xs ${senderNameClasses}`}>
                            {isSenderAdmin && <Crown size={14} className="text-yellow-500" title="‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"/>}
                            {isMe && !isSenderAdmin ? '‡∏Ñ‡∏∏‡∏ì' : msg.sender}
                        </span>
                    </div>
                    
                    {/* Message Bubble (with swipe translation) */}
                    <div 
                        style={{ transform: `translateX(${swipeOffset}px)`, transition: swipeOffset === 0 ? 'transform 0.15s ease-out' : 'none' }}
                        className={`max-w-[85%] rounded-2xl p-3 ${
                        isMe 
                        ? 'bg-blue-600 text-white rounded-br-sm shadow-blue-900/20' 
                        : (isSenderAdmin ? 'bg-yellow-800/80 text-white rounded-bl-sm border border-yellow-700 shadow-yellow-900/20' : 'bg-slate-800 text-slate-200 rounded-bl-sm border border-slate-700')
                    } shadow-lg relative`}>
                        
                        {/* 1. Confirmation Modal for Permanent Unlock */}
                        {isConfirmingUnlock ? (
                            <div className="bg-red-800/50 p-3 rounded-lg border border-red-700">
                                <p className="text-sm font-semibold text-red-300 mb-2">
                                    ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                                </p>
                                <p className="text-xs text-red-100 mb-3">
                                    ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ñ‡∏≤‡∏ß‡∏£‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
                                </p>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={handleUnlockConfirmed}
                                        className="flex-1 bg-red-600 hover:bg-red-500 text-white font-medium py-1.5 rounded-lg text-sm transition"
                                    >
                                        ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ñ‡∏≤‡∏ß‡∏£
                                    </button>
                                    <button 
                                        onClick={() => setIsConfirmingUnlock(false)}
                                        className="bg-slate-600 hover:bg-slate-500 text-white font-medium px-3 py-1.5 rounded-lg text-sm transition"
                                    >
                                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>
                                </div>
                            </div>
                        ) : displayPlaceholder ? (
                            /* 2. Locked Placeholder / Decryption Input */
                            <>
                                <p className="flex items-center gap-2 text-sm text-red-300 mb-2">
                                    <Lock size={16}/> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏ß‡πâ
                                </p>
                                
                                {isAdmin && !isAttemptingDecrypt && (
                                    <button 
                                        onClick={handleAdminDecrypt}
                                        className="mt-1 flex items-center gap-1 bg-yellow-600 hover:bg-yellow-500 text-white font-medium py-1.5 px-3 rounded-lg text-sm transition mb-2"
                                        title="‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÇ‡∏î‡∏¢ Admin (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™)"
                                    >
                                        <ShieldCheck size={14}/> ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÇ‡∏î‡∏¢ Admin
                                    </button>
                                )}
                                
                                {isAttemptingDecrypt ? (
                                    <div className="flex flex-col gap-2">
                                        <input
                                            type="password"
                                            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô"
                                            value={decryptKey}
                                            onChange={(e) => setDecryptKey(e.target.value)}
                                            onKeyPress={(e) => { if (e.key === 'Enter') handleDecrypt(); }}
                                            className="w-full bg-slate-700 border border-slate-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:border-red-400 placeholder:text-slate-500 text-sm"
                                        />
                                        {error && <p className="text-xs text-red-400">{error}</p>}
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={handleDecrypt}
                                                className="flex-1 bg-red-600 hover:bg-red-500 text-white font-medium py-2 rounded-lg text-sm transition"
                                            >
                                                <Eye size={16} className="inline mr-1" /> ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô
                                            </button>
                                            <button 
                                                onClick={handleRelock} 
                                                className="bg-slate-700 hover:bg-slate-600 text-white font-medium px-4 py-2 rounded-lg text-sm transition"
                                            >
                                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <button 
                                        onClick={() => setIsAttemptingDecrypt(true)}
                                        className="mt-1 flex items-center gap-1 bg-red-600 hover:bg-red-500 text-white font-medium py-1.5 px-3 rounded-lg text-sm transition"
                                    >
                                        <Key size={14}/> ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô
                                    </button>
                                )}
                            </>
                        ) : (
                            /* 3. Unlocked / Regular Content */
                            <>
                                {contentToDisplay.text && <p className="whitespace-pre-wrap break-words text-sm leading-relaxed">{contentToDisplay.text}</p>}
                                {contentToDisplay.image && (
                                    // Image Download
                                    <a 
                                        href={contentToDisplay.image} 
                                        download={`chat_image_${msg.id}.png`}
                                        className="mt-2 block"
                                        title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
                                    >
                                        <img 
                                            src={contentToDisplay.image} 
                                            className="rounded-lg max-h-48 w-full object-cover border border-black/20 cursor-pointer hover:opacity-90 transition" 
                                            alt="uploaded" 
                                        />
                                    </a>
                                )}
                                
                                {isAdmin && isLocked && decryptedContent && (
                                    <p className="mt-2 text-xs font-semibold text-yellow-300/80 bg-slate-700/50 p-1 rounded-lg">
                                        <ShieldCheck size={12} className="inline mr-1"/> (Admin View: Encrypted Content)
                                    </p>
                                )}
                            </>
                        )}
                        
                    </div>
                    
                    {/* Reactions Display */}
                    {Object.keys(msg.reactions || {}).length > 0 && (
                        <div className={`flex gap-1 mt-1 text-sm ${isMe ? 'mr-1' : 'ml-1'}`}>
                            {EMOJIS.filter(emoji => msg.reactions[emoji]?.length > 0).map(emoji => {
                                const count = msg.reactions[emoji].length;
                                const hasReacted = msg.reactions[emoji].includes(user.uid);
                                return (
                                    <div 
                                        key={emoji} 
                                        className={`flex items-center p-1 rounded-full text-xs font-medium cursor-pointer transition ${
                                            hasReacted ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            onUpdateReaction(msg.id, emoji);
                                        }}
                                        title={`${count} ‡∏Ñ‡∏ô reacted with ${emoji}`}
                                    >
                                        {emoji} <span className="ml-1 text-xs">{count}</span>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };
        
        // =================================================================
        // SettingsModal Component
        // =================================================================
        const SettingsModal = ({ user, isAdmin, onClose, onUpdateProfile }) => {
            const [newDisplayName, setNewDisplayName] = useState(user?.displayName || '');
            const [copyStatus, setCopyStatus] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const handleCopy = () => {
                try {
                    const el = document.createElement('textarea');
                    el.value = user.uid;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    setCopyStatus('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!');
                } catch (err) {
                    setCopyStatus('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ...');
                }
                setTimeout(() => setCopyStatus(''), 2000);
            };

            const handleSave = async () => {
                const name = newDisplayName.trim();
                if (!name || name === user?.displayName) return;
                
                setIsSaving(true);
                await onUpdateProfile(name);
                setIsSaving(false);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div 
                        className="bg-slate-800 rounded-xl p-6 w-full max-w-sm shadow-2xl border border-slate-700"
                        onClick={(e) => e.stopPropagation()} 
                    >
                        <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                            <h2 className="text-xl font-bold text-blue-400 flex items-center gap-2">
                                <Settings size={20}/> ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 
                                {isAdmin && <Crown size={20} className="text-yellow-500" title="Admin User"/>}
                            </h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition">
                                <X size={24} />
                            </button>
                        </div>

                        {/* 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ */}
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-slate-300 mb-1 flex items-center gap-1">
                                <User size={14}/> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                            </label>
                            <input 
                                type="text"
                                value={newDisplayName}
                                onChange={(e) => setNewDisplayName(e.target.value)}
                                placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà"
                                className="w-full bg-slate-700 border border-slate-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:border-blue-500 text-base"
                            />
                            <button 
                                onClick={handleSave}
                                disabled={isSaving || !newDisplayName.trim() || newDisplayName.trim() === user?.displayName}
                                className={`mt-2 w-full py-2 rounded-lg font-semibold transition ${
                                    isSaving || !newDisplayName.trim() || newDisplayName.trim() === user?.displayName
                                    ? 'bg-slate-700 text-slate-500' 
                                    : 'bg-blue-600 hover:bg-blue-500 text-white'
                                }`}
                            >
                                {isSaving ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠'}
                            </button>
                        </div>
                        
                        {/* 2. User ID */}
                        <div className="mb-4 pt-4 border-t border-slate-700">
                            <label className="block text-sm font-medium text-slate-300 mb-1 flex items-center gap-1">
                                <Key size={14}/> User ID (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô)
                            </label>
                            <div className="flex items-center gap-2">
                                <span className="flex-1 bg-slate-700 text-slate-300 text-xs px-3 py-2 rounded-lg truncate select-text">
                                    {user?.uid || 'Loading...'}
                                </span>
                                <button 
                                    onClick={handleCopy}
                                    className={`p-2 rounded-lg transition text-white ${copyStatus ? 'bg-green-600' : 'bg-slate-600 hover:bg-slate-500'}`}
                                >
                                    <Copy size={18} />
                                </button>
                            </div>
                            {copyStatus && <p className="text-xs text-green-400 mt-1">{copyStatus}</p>}
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================
        // App Component
        // =================================================================
        const App = () => {
            const ADMIN_UID = "mRhV0VcapENUjSUZs0wR9ce99Qg2";
            
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [image, setImage] = useState(null);
            const [lockCode, setLockCode] = useState(''); 
            const [isLocking, setIsLocking] = useState(false); // NEW: State for showing lock input
            const [loading, setLoading] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false); 
            const [replyTarget, setReplyTarget] = useState(null); 
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);
            const [initComplete, setInitComplete] = useState(false);
            const CHAT_COLLECTION = "public_chats";

            // Auth & Listen
            useEffect(() => {
                if (!auth || !db) return;
                
                // 1. Login Anonymously
                signInAnonymously(auth).catch(err => console.error("Auth Failed:", err));
                
                const unsubAuth = onAuthStateChanged(auth, u => {
                    if (u) {
                        setUser(u);
                        setIsAdmin(u.uid === ADMIN_UID);
                        
                        if (!u.displayName) {
                            const defaultName = `Anonymous-${u.uid.slice(0,4)}`;
                            updateProfile(u, { displayName: defaultName });
                            setUser(prev => ({ ...prev, displayName: defaultName }));
                        }
                        setInitComplete(true);
                    }
                });

                return () => unsubAuth();
            }, []);
            
            // 2. Data Listener (Only runs after Auth is complete)
            useEffect(() => {
                if (!initComplete) return;

                const q = query(collection(db, CHAT_COLLECTION), orderBy("createdAt", "desc"), limit(50));
                
                const unsubMsg = onSnapshot(q, (snapshot) => {
                    setMessages(snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(),
                        reactions: doc.data().reactions || {}
                    })).reverse());
                    setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
                }, (error) => {
                    console.error("Snapshot Error (Data Listener):", error);
                });

                return () => unsubMsg();
            }, [initComplete]);
            
            
            const handleSend = async (e) => {
                e.preventDefault();
                const text = inputText.trim();
                const code = lockCode.trim();

                if ((!text && !image) || loading || !user) return;
                
                setLoading(true);
                try {
                    let imageBase64 = null;
                    if (image) {
                        imageBase64 = await compressImage(image);
                    }
                    
                    let messageData = {
                        sender: user?.displayName || 'Anonymous',
                        uid: user?.uid,
                        createdAt: serverTimestamp(),
                        isLocked: false,
                        text: text,
                        image: imageBase64,
                        reactions: {}
                    };
                    
                    if (replyTarget) {
                        messageData.replyToId = replyTarget.id;
                        messageData.replyToSender = replyTarget.sender;
                        messageData.replyToText = replyTarget.text;
                    }

                    if (isLocking && code) { // Only encrypt if lock button was pressed AND code is provided
                        const contentToEncrypt = JSON.stringify({
                            text: text,
                            image: imageBase64
                        });
                        
                        const encrypted = CryptoJS.AES.encrypt(contentToEncrypt, code).toString();

                        messageData.isLocked = true;
                        messageData.encryptedContent = encrypted;
                        
                        messageData.text = '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™'; // Placeholder text for database view
                        messageData.image = null;
                        
                        setLockCode(''); 
                        setIsLocking(false); // Reset lock state after sending
                    } else if (isLocking && !code) {
                         // If lock button was pressed but no code, cancel sending or prompt error. 
                         // For now, we'll just send it unlocked if there is no code.
                         setIsLocking(false);
                    }


                    await addDoc(collection(db, CHAT_COLLECTION), messageData);

                    setInputText('');
                    setImage(null);
                    setReplyTarget(null);
                    setLoading(false);
                } catch (error) {
                    console.error("Send Error:", error);
                    // Use custom message box or log error instead of window.alert
                    console.error("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + error.message);
                    setLoading(false);
                }
            };
            
            const handleDelete = async (id) => {
                const msgToDelete = messages.find(m => m.id === id);
                if (!msgToDelete || (msgToDelete.uid !== user?.uid && user?.uid !== ADMIN_UID)) {
                    // Use custom message box or log error instead of window.alert
                    console.error("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ");
                    return;
                }
                
                // Note: The original code used window.confirm, which is forbidden. Replacing with console log.
                // In a real app, this would be a custom modal.
                const confirmed = confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"); 
                if (!confirmed) return;


                try {
                    await deleteDoc(doc(db, CHAT_COLLECTION, id));
                } catch (error) {
                    console.error("Delete Error:", error);
                    // Use custom message box or log error instead of window.alert
                    console.error("‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + error.message);
                }
            };
            
            const handlePermanentUnlock = async (id, encryptedContent, key) => {
                setLoading(true);
                try {
                    const decryptedData = decryptData(encryptedContent, key);
                    
                    if (!decryptedData) {
                        // Use custom message box or log error instead of window.alert
                        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ (‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)");
                        setLoading(false);
                        return;
                    }

                    const messageRef = doc(db, CHAT_COLLECTION, id);
                    await updateDoc(messageRef, {
                        isLocked: false,
                        text: decryptedData.text || '', 
                        image: decryptedData.image || null, 
                        encryptedContent: deleteField(), 
                    });
                    
                    setLoading(false);
                } catch (error) {
                    console.error("Permanent Unlock Error:", error);
                    // Use custom message box or log error instead of window.alert
                    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ñ‡∏≤‡∏ß‡∏£‡πÑ‡∏î‡πâ: " + error.message);
                    setLoading(false);
                }
            };
            
            const handleUpdateReaction = async (messageId, emoji) => {
                if (!user || !messageId) return;

                const messageRef = doc(db, CHAT_COLLECTION, messageId);
                const userId = user.uid;
                const path = `reactions.${emoji}`; 

                try {
                    const msg = messages.find(m => m.id === messageId);
                    if (!msg) return;

                    const currentReactionUids = msg.reactions?.[emoji] || [];

                    if (currentReactionUids.includes(userId)) {
                        await updateDoc(messageRef, {
                            [path]: arrayRemove(userId)
                        });
                    } else {
                        await updateDoc(messageRef, {
                            [path]: arrayUnion(userId)
                        });
                    }
                } catch (error) {
                    console.error("Update Reaction Error:", error);
                    // Use custom message box or log error instead of window.alert
                    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏£‡∏µ‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏î‡πâ: " + error.message);
                }
            };

            const handleReply = (msg, contentToDisplay) => {
                let textPreview = contentToDisplay.text || '';

                if (msg.isLocked && !contentToDisplay.text && !contentToDisplay.image) {
                     textPreview = "üîí ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™";
                } else if (!textPreview && contentToDisplay.image) {
                    textPreview = "üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û";
                }
                
                const truncatedText = textPreview.slice(0, 50) + (textPreview.length > 50 ? '...' : '');

                setReplyTarget({
                    id: msg.id,
                    sender: msg.sender,
                    text: truncatedText,
                });
            };
            
            const handleUpdateProfile = async (newDisplayName) => {
                if (!user || !auth.currentUser) return;
                try {
                    await updateProfile(auth.currentUser, { displayName: newDisplayName });
                    setUser(prev => ({ ...prev, displayName: newDisplayName }));
                } catch (error) {
                    console.error("Update Profile Error:", error);
                    // Use custom message box or log error instead of window.alert
                    console.error("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + error.message);
                }
            };

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    setImage(file);
                } else if (file) {
                    // Use custom message box or log error instead of window.alert
                    console.error("‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                    e.target.value = null;
                }
            };

            if (!initComplete) {
                return (
                    <div className="h-screen flex items-center justify-center bg-slate-900 text-slate-400">
                        <div className="flex items-center space-x-2">
                            <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-slate-950 border-x border-slate-800 shadow-2xl">
                    
                    {/* Header (Fixed - Removed Collapsible Logic) */}
                    <header className={`bg-slate-900 border-b border-slate-800 z-10 p-4 shadow-md`}>
                        <div className="flex justify-between items-center">
                            {/* App Title and Status */}
                            <div className="flex items-center gap-2">
                                <div className="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                                <h1 className="font-bold text-lg bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Global Chat</h1>
                            </div>
                            
                            {/* User Info and Settings Button */}
                            <div className="flex items-center gap-2">
                                <span className={`text-sm truncate max-w-[150px] ${isAdmin ? 'text-yellow-400 font-semibold' : 'text-slate-400'}`}>
                                    {user?.displayName}
                                </span>
                                {isAdmin && <Crown size={18} className="text-yellow-500" title="‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"/>}
                                <button 
                                    onClick={() => setShowSettingsModal(true)}
                                    className="p-2 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-300 transition"
                                    title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"
                                >
                                    <Settings size={18} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Messages Area */}
                    <main className="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar bg-slate-950">
                        {loading && (
                            <div className="text-center text-yellow-400 text-sm py-2">
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...
                            </div>
                        )}
                        {messages.length === 0 && (
                            <div className="text-center text-slate-600 mt-20 text-sm">
                                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>
                                <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å!</p>
                            </div>
                        )}
                        
                        {messages.map((msg) => (
                            <MessageItem 
                                key={msg.id} 
                                msg={msg} 
                                isMe={msg.uid === user?.uid} 
                                isAdmin={isAdmin} 
                                user={user} 
                                onDelete={handleDelete}
                                onPermanentUnlock={handlePermanentUnlock} 
                                onReply={handleReply} 
                                onUpdateReaction={handleUpdateReaction} 
                            />
                        ))}
                        <div ref={messagesEndRef}></div>
                    </main>

                    {/* Input Area (Footer - Fixed) */}
                    <footer className={`bg-slate-900 border-t border-slate-800 shadow-md p-3`}>
                        
                        {/* 1. Reply Preview */}
                        {replyTarget && (
                            <div className="flex items-center justify-between bg-slate-800 p-2 rounded-t-xl border border-b-0 border-slate-700">
                                <div className="flex flex-col text-xs text-slate-400 border-l-2 border-blue-500 pl-2 max-w-[90%] truncate">
                                    <span className="font-semibold text-blue-300">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö {replyTarget.sender}</span>
                                    <span className="truncate text-slate-300">{replyTarget.text}</span>
                                </div>
                                <button onClick={() => setReplyTarget(null)} className="text-slate-500 hover:text-white transition p-1">
                                    <X size={16} />
                                </button>
                            </div>
                        )}
                        
                        {/* 2. Lock Code Input (Shown only when isLocking is true) */}
                        {isLocking && (
                            <div className="mb-2 flex items-center gap-2 pt-2">
                                <Key size={16} className={lockCode ? "text-yellow-400" : "text-slate-500"}/>
                                <input 
                                    type="password"
                                    value={lockCode}
                                    onChange={(e) => setLockCode(e.target.value)}
                                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" 
                                    className="flex-1 bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:border-yellow-500 transition-all placeholder:text-slate-600 text-sm"
                                    autoFocus // Automatically focus when shown
                                />
                                <button onClick={() => {setLockCode(''); setIsLocking(false);}} className="p-1 bg-slate-700 hover:bg-slate-600 rounded-full text-slate-400" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ">
                                    <X size={14}/>
                                </button>
                            </div>
                        )}

                        {/* 3. Image Preview */}
                        {image && (
                            <div className="flex items-center gap-2 bg-slate-800 p-2 rounded-lg mb-2 w-fit border border-slate-700">
                                <span className="text-xs text-blue-300 truncate max-w-[150px]">{image.name}</span>
                                <button onClick={() => {setImage(null); fileInputRef.current.value=''}} className="text-slate-400 hover:text-red-400"><X size={14}/></button>
                            </div>
                        )}
                        
                        {/* 4. Main Send Form */}
                        <form onSubmit={handleSend} className="flex gap-2 items-end">
                            
                            {/* Image Picker */}
                            <button type="button" onClick={() => fileInputRef.current?.click()} className="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl transition text-slate-400" title="‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
                                <ImageIcon size={20} className={image ? "text-blue-400" : ""} />
                            </button>
                            <input type="file" ref={fileInputRef} onChange={handleFile} accept="image/*" className="hidden" />
                            
                            {/* Toggle Lock Code Input */}
                            <button 
                                type="button" 
                                onClick={() => {
                                    setIsLocking(!isLocking);
                                    if (isLocking) setLockCode(''); // Clear code if turning off
                                }}
                                className={`p-3 rounded-xl transition-all shadow-lg ${
                                    isLocking
                                    ? 'bg-yellow-600 hover:bg-yellow-500 text-white shadow-yellow-600/20' 
                                    : 'bg-slate-800 hover:bg-slate-700 text-slate-400'
                                }`}
                                title={isLocking ? "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™" : "‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™"}
                            >
                                <Lock size={20} />
                            </button>

                            {/* Text Input */}
                            <div className="flex-1 relative">
                                <input 
                                    type="text" 
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." 
                                    className="w-full bg-slate-800 border border-slate-700 text-white px-4 py-3 rounded-xl focus:outline-none focus:border-blue-500 transition-all placeholder:text-slate-600"
                                />
                            </div>

                            {/* Send Button */}
                            <button type="submit" disabled={loading || (!inputText && !image)} 
                                className={`p-3 rounded-xl transition-all shadow-lg ${
                                    loading || (!inputText && !image) 
                                    ? 'bg-slate-800 text-slate-600' 
                                    : 'bg-blue-600 hover:bg-blue-500 text-white shadow-blue-600/20'
                                }`}
                                title="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"
                            >
                                {loading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Send size={20} />}
                            </button>
                        </form>
                    </footer>
                    
                    {/* Settings Modal */}
                    {showSettingsModal && (
                        <SettingsModal 
                            user={user} 
                            isAdmin={isAdmin}
                            onClose={() => setShowSettingsModal(false)} 
                            onUpdateProfile={handleUpdateProfile}
                        />
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
